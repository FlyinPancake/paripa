<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Linux kernel reverse engineering</title>
<meta name="author" content="P√°lv√∂lgyi Domonkos"/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="/home/flyinpancake/.config/emacs/.local/straight/build-27.2/revealjs/dist/reveal.css"/>

<link rel="stylesheet" href="./robot-lung.css" id="theme"/>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide">
<h1>Linux kernel reverse engineering</h1><h2></h2><h3> P√°lv√∂lgyi Domonkos</h3>
</section>

<section>
<section id="slide-org7435000">
<h2 id="org7435000">Motivation</h2>
</section>
</section>
<section>
<section id="slide-org69a845b">
<h2 id="org69a845b">Why do we need this?</h2>
<ul>
<li>Linux is one of the most well known piece of open source software</li>
<li>Not every Linux-based device is open</li>
<li>Especially in the IoT space</li>

</ul>
</section>
<section id="slide-org1acaeb8">
<h3 id="org1acaeb8">Embedded devices</h3>
<ul>
<li>Often run 5-8 years old software</li>
<li>Updates are few and far between</li>
<li>Security researchers be like</li>

</ul>

<div id="org1c085cd" class="figure">
<p><img src="./1.jpg" alt="1.jpg" width="50%" />
</p>
</div>
</section>
<section id="slide-orgd406f03">
<h3 id="orgd406f03">Scale of the issue</h3>
<ul>
<li>In 2020 there were an estimated 10 connected devices per household</li>
<li>IoT devices are attacked just 5 minutes after connecting to the internet</li>
<li>75% of attacks target routers</li>
<li>48% of businesses admit that they can&rsquo;t detect IoT security breaches</li>

</ul>
<div class="slide-footer"><a href="https://findstack.com/internet-of-things-statistics">source</a></div>
</section>
</section>
<section>
<section id="slide-org5aeeab4">
<h2 id="org5aeeab4">IoT security testing</h2>
<ul>
<li>The best-case scenario is using real hardware</li>
<li>Not practical
<ul>
<li>cost</li>
<li>inconvenience</li>
<li>lack of controlled environment</li>

</ul></li>

</ul>
</section>
<section id="slide-org229fb9d">
<h3 id="org229fb9d">Emulation</h3>
<ul>
<li>A device&rsquo;s software can be ran on virtual hardware (in theory)</li>
<li>Specialized devices have special hardware</li>
<li>Special hardware can rarely be emulated</li>

</ul>
</section>
<section id="slide-orgf45090a">
<h3 id="orgf45090a">What can be done?</h3>
<ul>
<li>Firmware can be downloaded and analysed without running it</li>
<li>The Linux kernel powering these devices can be substituted</li>
<li>The substituted kernel has to be compatible with the existing software</li>
<li>The original kernel has to be closely resembled</li>

</ul>
</section>
</section>
<section>
<section id="slide-org16ca40e">
<h2 id="org16ca40e">Linux build system</h2>
<ul>
<li>Linux is built using a configuration file.</li>
<li>Same source + same configuration = same kernel</li>
<li>If we can recreate configuration file we can closely resemble the original kernel</li>

</ul>
</section>
<section id="slide-org89ad9e5">
<h3 id="org89ad9e5">Configuration file</h3>
<ul>
<li>usually <code>.config</code></li>
<li>Its structure is as follows</li>

</ul>
<pre class="example">
CONFIG_OPTION=value
CONFIG_BINARY_OPTION=y
CONFIG_INT_OPTION=11
CONFIG_TRISTATE_OPTION=m
</pre>
<ul>
<li>It is generated from <code>Kconfig</code> files</li>

</ul>
</section>
<section id="slide-orgee0e60b">
<h3 id="orgee0e60b">Kconfig file</h3>
<ul>
<li>Multiple ones across the source files of Linux</li>

</ul>
<pre class="example" id="orgbeae6e8">
‚ûú fd Kconfig
virt/kvm/Kconfig
sound/Kconfig
usr/Kconfig
security/Kconfig
security/Kconfig.hardening
security/yama/Kconfig
security/selinux/Kconfig
sound/parisc/Kconfig
...
</pre>
</section>
<section id="slide-org7ec1460">
<h4 id="org7ec1460"><code>Kconfig</code> structure</h4>
<pre class="example" id="org0c00243">
‚ûú cat virt/kvm/Kconfig
...
config KVM_GENERIC_DIRTYLOG_READ_PROTECT
       bool

config KVM_COMPAT
       def_bool y
       depends on KVM &amp;&amp; COMPAT &amp;&amp; !(S390 || ARM64)
...
</pre>
<ul>
<li><code>Kconfig</code> files contain the options that control what is compiled into a kernel</li>
<li>As well as how menus like seen in <code>menuconfig</code> are structured</li>
<li>The <code>Kconfig</code> language is described in the Linux documentation under <code>Documentation/kbuild/kconfig-language.rst</code></li>

</ul>
</section>
<section id="slide-org0ae3749">
<h4 id="org0ae3749">Some <code>Kconfig</code> fields</h4>
<ul>
<li><code>config</code>
<ul>
<li>contains option name</li>
<li>describes dependencies
<ul>
<li>depend on -&gt; can only be set if the dependency is met</li>
<li>selects -&gt; if set, it enables an other option</li>

</ul></li>

</ul></li>
<li><code>if</code>
<ul>
<li>enables options if dependency is met</li>
<li>usually contains multiple fields. (config, if, menu etc.)</li>

</ul></li>
<li><code>menu</code>
<ul>
<li>describes a submenu to help the menu structure, has no use when parsing into a data structure</li>

</ul></li>
<li><code>source</code>
<ul>
<li>loads an other <code>Kconfig</code> in its place</li>

</ul></li>

</ul>
</section>
<section>
<ul>
<li><code>menuconfig</code> is a menu and a config baked into one field, has no end symbol unlike menu.</li>

</ul>
</section>
<section id="slide-orgc0e929b">
<h4 id="orgc0e929b">Parser</h4>
<ul>
<li>implemented a basic <code>Kconfig</code> parser to extract all the available options from a kernel source</li>
<li><p>
published as a Rust crate
</p>

<div id="org921fe0c" class="figure">
<p><img src="./kconfig_rs.png" alt="kconfig_rs.png" width="50%" style="display:block; margin-left: auto; margin-right: auto;" />
</p>
</div></li>
<li>its main use is to programically represent the contents of all <code>Kconfig</code> files in Linux</li>

</ul>
</section>
<section id="slide-org977d886">
<h4 id="org977d886">Parser algorithm</h4>
<pre class="example">
...
config ACPI_CONFIGFS
	tristate "ACPI configfs support"
	select CONFIGFS_FS
	help
	  Select this option to enable support for ACPI configuration from
	  userspace. The configurable ACPI groups will be visible under
	  /config/acpi, assuming configfs is mounted under /config.

if ARM64
source "drivers/acpi/arm64/Kconfig"

config ACPI_PPTT
	bool
endif
...
</pre>
</section>
</section>
<section>
<section id="slide-orga154fd6">
<h2 id="orga154fd6">Building older Linux kernels for other architectures</h2>
<ul>
<li>IoT devices are rarely based on the desktop standard x86 architecture</li>
<li>Cross compilation is needed in most cases</li>
<li>The target is to build Linux v2.6.x for ARM</li>
<li>cross compilation methods:
<ul>
<li>setting environment variables (<code>CROSS_COMPILE</code> and <code>ARCH</code>)</li>
<li>docker containers</li>
<li>virtual machines</li>
<li>Buildroot</li>

</ul></li>

</ul>
</section>
<section id="slide-orgd48eec3">
<h3 id="orgd48eec3">Vanilla cross compilation</h3>
<ul>
<li>Usually every Linux distribution ships a cross compiler</li>
<li>Linux distributions only support newer GCC versions</li>
<li>Older GCC versions are hard to install</li>

</ul>
</section>
<section id="slide-org1efa0de">
<h3 id="org1efa0de">Docker containers and VMs</h3>
<ul>
<li>Create an isolated light-weight environment that has the correct version of GCC</li>
<li>Older docker images often have trouble with dead repositories</li>
<li>Ubuntu 16.04 still has most of its repositories online unlike 14.04</li>
<li>The latest GCC is 4.9 but it is not called by <code>gcc</code> rather <code>gcc-4.9</code></li>
<li>Makefile has to be patched</li>
<li>Every time fails due to some error mid-compilation</li>
<li>VMs have similar issues as containers, as well as the added weight of the whole system</li>

</ul>
</section>
<section id="slide-org273572a">
<h3 id="org273572a">Buildroot</h3>
<ul>
<li>It is a complete toolbox to build embedded system images</li>
<li>Configuration is similar to the Linux kernel</li>
<li>Uses git for version management so older versions are available</li>
<li>Contains all source code for gcc so package repositories don&rsquo;t cause problems</li>
<li>Configuration file can be set by <code>BR2_LINUX_KERNEL_CUSTOM_CONFIG_FILE</code></li>

</ul>
</section>
</section>
<section>
<section id="slide-orgb0e8d78">
<h2 id="orgb0e8d78">My tools</h2>
<div class="outline-text-2" id="text-orgb0e8d78">
</div>
</section>
<section id="slide-orgf3fac83">
<h3 id="orgf3fac83">Kernel choice</h3>
<ul>
<li>OpenWRT so I can test multiple initial configurations</li>
<li><code>armvirt-32</code> as the architecture</li>
<li>Newer version (5.4.188)</li>
<li>OpenWRT uses a fork of Buildroot</li>
<li>Compilation is not short and both storage (~40GB) and memory (8 GiB for 8 jobs) intensive.</li>

</ul>
</section>
</section>
<section>
<section id="slide-org0d4042d">
<h2 id="org0d4042d"><code>stringhunter</code></h2>
<div class="outline-text-2" id="text-org0d4042d">
</div>
</section>
<section id="slide-org09b5bc0">
<h3 id="org09b5bc0">V1</h3>
<ul>
<li>Written in python</li>
<li>Only one option per run</li>
<li>Reads trough the whole source code with regular expressions</li>
<li>üêå</li>
<li>bottlenecks:
<ul>
<li>disk speed</li>
<li>no parallel running</li>
<li>the python regular expression library is quite slow</li>

</ul></li>

</ul>
</section>
<section id="slide-orgf140168">
<h3 id="orgf140168">V2</h3>
<ul>
<li>Written in Rust</li>
<li>Utilizes <code>kconfig-linux</code> crate</li>
<li>Extracts source blocks defined by macros (<code>#if defined(x)</code> and <code>#ifdef</code>)</li>
<li>Uses similar algorithm for parsing as <code>kconfig-linux</code></li>

</ul>

<div class="org-src-container">

<pre class="src src-c"><span style="color: #87ceeb;">int</span> <span style="color: #e95678;">main</span> {
<span style="color: #87ceeb; font-weight: bold;">#ifdef</span> CONFIG_FIRST
    printf(<span style="color: #fab795;">"Bears. Beets. Battlestar Galactica."</span>);
<span style="color: #87ceeb; font-weight: bold;">#if</span> <span style="color: #87ceeb; font-weight: bold;">defined</span>(CONFIG_SECOND)
    printf(<span style="color: #fab795;">"The worst thing about prison was the dementors."</span>);
<span style="color: #87ceeb; font-weight: bold;">#endif</span>
<span style="color: #87ceeb; font-weight: bold;">#ifdef</span> CONFIG_THIRD
    printf(<span style="color: #fab795;">"I talk a lot, so I&#8217;ve learned to tune myself out."</span>);
<span style="color: #87ceeb; font-weight: bold;">#endif</span>
<span style="color: #87ceeb; font-weight: bold;">#endif</span>
<span style="color: #87ceeb; font-weight: bold;">#ifdef</span> CONFIG_FOURTH
    printf(<span style="color: #fab795;">"Today, smoking is going to save lives."</span>);
<span style="color: #87ceeb; font-weight: bold;">#endif</span>
    printf(<span style="color: #fab795;">"PARKOUR!"</span>);
    <span style="color: #b877db;">return</span> <span style="color: #f09383; font-weight: bold;">0</span>;
}
</pre>
</div>
</section>
<section>
<div class="org-src-container">

<pre class="fragment (fade-in)">    printf(<span style="color: #fab795;">"Bears. Beets. Battlestar Galactica."</span>);
<span style="color: #87ceeb; font-weight: bold;">#if</span> <span style="color: #87ceeb; font-weight: bold;">defined</span>(CONFIG_SECOND)
    printf(<span style="color: #fab795;">"The worst thing about prison was the dementors."</span>);
<span style="color: #87ceeb; font-weight: bold;">#endif</span>
<span style="color: #87ceeb; font-weight: bold;">#ifdef</span> CONFIG_THIRD
    printf(<span style="color: #fab795;">"I talk a lot, so I&#8217;ve learned to tune myself out."</span>);
<span style="color: #87ceeb; font-weight: bold;">#endif</span>
</pre>
</div>
<div class="org-src-container">

<pre class="fragment (fade-in)">    printf(<span style="color: #fab795;">"Today, smoking is going to save lives."</span>);
</pre>
</div>
<div class="org-src-container">

<pre class="fragment (fade-in)">    printf(<span style="color: #fab795;">"The worst thing about prison was the dementors."</span>);
</pre>
</div>
<div class="org-src-container">

<pre class="fragment (fade-in)">    printf(<span style="color: #fab795;">"I talk a lot, so I&#8217;ve learned to tune myself out."</span>);
</pre>
</div>
</section>
<section id="slide-org5ed894f">
<h4 id="org5ed894f">output</h4>
<div class="org-src-container">

<pre class="src src-json">[
    {
    <span style="color: #b877db;">"CONFIG_NAME"</span>: [
        <span style="color: #fab795;">"List"</span>,
        <span style="color: #fab795;">"of"</span>,
        <span style="color: #fab795;">"lines"</span>
    ]
    }, ...
]
</pre>
</div>
</section>
</section>
<section>
<section id="slide-orgaab7885">
<h2 id="orgaab7885">Python tools</h2>
<ul>
<li>other tools have been written in python/go for rapid development</li>
<li>python is a well known language</li>
<li>many useful libraries</li>

</ul>
</section>
<section id="slide-org1bcff00">
<h3 id="org1bcff00"><code>find_strings</code></h3>
<pre class="example" id="org424a914">
usage: find_strings.py [-h] [-o OUTPUT] INPUT

Extracting strings from stringhunter's JSON output.

positional arguments:
  INPUT                 JSON file generated by stringhunter (sources.json)

options:
  -h, --help            show this help message and exit
  -o OUTPUT, --output OUTPUT
                        JSON with argument names and strings
</pre>
<ul>
<li>uses the <code>hardcodes</code> library</li>
<li>runs in some seconds -&gt; tolerable performance</li>
<li>outputs structured JSON</li>

</ul>
<div class="org-src-container">

<pre class="src src-json">[
    {
    <span style="color: #b877db;">"CONFIG_NAME"</span>: [
        <span style="color: #fab795;">"List"</span>,
        <span style="color: #fab795;">"of"</span>,
        <span style="color: #fab795;">"hardcoded"</span>,
        <span style="color: #fab795;">"strings"</span>
    ]
    }, ...
]
</pre>
</div>
</section>
<section id="slide-org0de1f9b">
<h3 id="org0de1f9b"><code>dedup_strings</code></h3>
<pre class="example" id="org7488c7b">
usage: dedup_strings.py [-h] [-o OUTPUT] INPUT

Remove duplicate strings from strings.json

positional arguments:
  INPUT                 JSON file generated by find_strings (strings.json)

options:
  -h, --help            show this help message and exit
  -o OUTPUT, --output OUTPUT
                        JSON with deduplicated strings
</pre>
<ul>
<li>removes strings that appear in multiple configs</li>
<li>optional</li>
<li>same format as <code>find_strings</code></li>

</ul>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #b877db;">for</span> config_name, strings <span style="color: #b877db;">in</span> configs_strings.items():
    <span style="color: #b877db;">for</span> other_config_name, other_strings <span style="color: #b877db;">in</span> configs_strings.items():
        <span style="color: #b877db;">if</span> config_name == other_config_name:
            <span style="color: #b877db;">continue</span>

        <span style="color: #b877db;">for</span> string <span style="color: #b877db;">in</span> strings:
            <span style="color: #b877db;">if</span> string <span style="color: #b877db;">in</span> other_strings:
                configs_strings[config_name].remove(string)
                configs_strings[other_config_name].remove(string)
</pre>
</div>
</section>
<section id="slide-org943dc1f">
<h3 id="org943dc1f"><code>ink-checker</code></h3>
<ul>
<li>in-kernel-checker: checks if an option&rsquo;s strings are present in a binary</li>
<li>reads the characters found in the kernel binary into a string</li>
<li>has a JSON input with config names and strings</li>
<li>checks all the strings of a config and looks for them in the kernel strings</li>

</ul>
</section>
</section>
<section>
<section id="slide-org1a1837d">
<h2 id="org1a1837d">Test results</h2>
</section>
</section>
<section>
<section id="slide-orgdcf1722">
<h2 id="orgdcf1722">Improvements</h2>
</section>
</section>
<section>
<section id="slide-orgbc188d8">
<h2 id="orgbc188d8">Thanks</h2>
</section>
</section>
</div>
</div>
<script src="/home/flyinpancake/.config/emacs/.local/straight/build-27.2/revealjs/dist/reveal.js"></script>
<script src="/home/flyinpancake/.config/emacs/.local/straight/build-27.2/revealjs/plugin/markdown/markdown.js"></script>
<script src="/home/flyinpancake/.config/emacs/.local/straight/build-27.2/revealjs/plugin/notes/notes.js"></script>
<script src="/home/flyinpancake/.config/emacs/.local/straight/build-27.2/revealjs/plugin/search/search.js"></script>
<script src="/home/flyinpancake/.config/emacs/.local/straight/build-27.2/revealjs/plugin/zoom/zoom.js"></script>
<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

controls: true,
progress: true,
history: false,
center: true,
slideNumber: 'c',
rollingLinks: false,
keyboard: true,
mouseWheel: false,
fragmentInURL: false,
hashOneBasedIndex: false,
pdfSeparateFragments: true,
overview: true,

transition: 'slide',
transitionSpeed: 'default',

// Plugins with reveal.js 4.x
plugins: [ RevealMarkdown, RevealNotes, RevealSearch, RevealZoom ],

// Optional libraries used to extend reveal.js
dependencies: [
]

});
</script>
</body>
</html>
